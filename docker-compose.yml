version: '3.8'

services:
  blockchain:
    image: node:18-alpine
    working_dir: /app
    volumes:
      - .:/app
    ports:
      - "8545:8545"
    command: npx hardhat node --hostname 0.0.0.0 --port 8545
    networks:
      - vault-network

  deployer:
    image: node:18-alpine
    working_dir: /app
    depends_on:
      - blockchain
    volumes:
      - .:/app
    environment:
      - HARDHAT_NETWORK=localhost
    command: >
      sh -c "
        echo 'Waiting for blockchain to be ready...'
        sleep 5
        echo 'Installing dependencies...'
        npm install
        echo 'Compiling contracts...'
        npx hardhat compile
        echo 'Deploying contracts...'
        npx hardhat run scripts/deploy.js --network localhost
        echo 'Deployment complete!'
        sleep infinity
      "
    networks:
      - vault-network

networks:
  vault-network:
    driver: bridge
